<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Agent Panel</title>
    
<script src="https://cdn.tailwindcss.com"></script>
    
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLMDJ8g2YJTIy2E/lKScVq4F3f9G5bQx2T/Bw2tI8g1e/Q71W+I8g1e/Q71W+I4G9Fh7G9C0Q="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* Setup for Inter font and light theme body styles */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f4f5;
            /* bg-zinc-100 */
            min-height: 100vh;
        }

        /* Base Card Styling (Reduced rounding: rounded-sm) */
        .card-base {
            transition: all 0.3s ease-in-out;
            border-radius: 0.125rem;
            /* rounded-sm */
        }

        .card-base:hover {
            transform: translateY(-1px);
        }

        /* Smaller, status dot - kept circular for functional appearance */
        .status-dot {
            width: 8px;
            height: 8px;
            min-width: 8px;
            min-height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        /* Action buttons refined for consistency and modern look */
        .action-btn {
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            /* CHANGED: From rounded-full to rounded-sm */
            border-radius: 0.125rem; 
            transition: all 0.2s ease;
            /* Added a heavier shadow for contrast */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); 
        }

        .action-btn:hover {
            box-shadow: 0 8px 10px -3px rgba(0, 0, 0, 0.15), 0 4px 6px -4px rgba(0, 0, 0, 0.15);
        }

        /* Monochrome Pulse for Status (used in Detail View only) */
        .mono-pulse-btn {
            animation: mono-pulse-ring 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes mono-pulse-ring {
            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(0, 0, 0, 0.2);
            }

            50% {
                box-shadow: 0 0 0 12px rgba(0, 0, 0, 0);
            }
        }

        /* Utility for showing loading state on a specific card */
        .starting-session {
            opacity: 0.5;
            pointer-events: none;
            cursor: not-allowed;
        }

        /* Agent Toggle Button Base Styling */
        .agent-toggle-btn {
            appearance: none;
            outline: none;
            cursor: pointer;
            border: none;
        }
    </style>
</head>

<body>
    
<div id="app" class="max-w-6xl mx-auto space-y-4 bg-white p-0 rounded-sm shadow-xl">
        <div class="p-20 text-center text-gray-500"><i class="fas fa-spinner fa-spin text-2xl mr-2"></i> Initializing App...</div>
    </div>


    
<div id="new-profile-modal"
        class="fixed inset-0 z-50 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden" role="dialog"
        aria-modal="true" aria-labelledby="modal-title">

        
<div class="bg-white p-6 rounded-sm shadow-2xl max-w-sm w-full mx-4 border-2 border-gray-400">
            <h3 id="modal-title" class="text-xl font-semibold mb-4 text-gray-800 border-b-2 border-gray-300 pb-2">Create New Profile</h3>
            <form id="new-profile-form" class="space-y-4">
                <div>
                    <label for="profile-name-input" class="block text-sm font-medium text-gray-700 mb-1">Profile
                        Name</label>
                    <input type="text" id="profile-name-input" name="profileName" required
                        placeholder="e.g., Sales Lead Generator"
                        class="mt-1 block w-full px-3 py-2 border-2 border-gray-400 rounded-sm shadow-sm focus:outline-none focus:ring-gray-900 focus:border-gray-900 transition duration-150">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Launch Mode</label>
                    <div class="flex items-center space-x-4">
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="launchMode" value="headless" checked
                                class="form-radio h-4 w-4 text-gray-900 focus:ring-gray-900 transition duration-150 border-gray-400">
                            <span class="ml-2 text-sm text-gray-700">Headless (No UI)</span>
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="launchMode" value="visible"
                                class="form-radio h-4 w-4 text-gray-900 focus:ring-gray-900 transition duration-150 border-gray-400">
                            <span class="ml-2 text-sm text-gray-700">Visible Browser</span>
                        </label>
                    </div>
                    <p class="text-xs text-gray-400 mt-1">Visible mode is slower and for debugging only.</p>
                </div>
                <div class="flex justify-end space-x-3 pt-2 border-t border-gray-200">
                    <button type="button" id="close-modal-btn"
                        class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-sm border-2 border-gray-300 hover:bg-gray-200 transition duration-150">
                        Cancel
                    </button>
                    <button type="submit"
                        class="px-4 py-2 text-sm font-medium text-white bg-gray-900 rounded-sm hover:bg-black transition duration-150 border-2 border-gray-900">
                        <i class="fas fa-rocket mr-2"></i> Launch
                    </button>
                </div>
            </form>
            <p id="modal-message" class="mt-4 text-sm text-center text-red-500 hidden"></p>
        </div>
    </div>

    <!-- Floating Log Sidebar (NEW) -->
    <aside id="floating-log-sidebar"
        class="fixed top-0 right-0 h-full w-full sm:w-96 bg-gray-900 text-gray-200 shadow-2xl z-50 p-6
        transform transition-transform duration-300 ease-in-out translate-x-full border-l-4 border-blue-400">

        <div class="flex justify-between items-center mb-4 pb-2 border-b-2 border-gray-700">
            <h3 class="text-xl font-bold text-gray-100 flex items-center">
                <i class="fas fa-terminal mr-2 text-blue-400"></i> Real-Time Log Console
            </h3>
            <button id="close-log-btn"
                class="text-gray-400 hover:text-white transition duration-150 p-1 rounded-sm hover:bg-gray-800 focus:outline-none"
                onclick="toggleLogVisibility(selectedSessionId)">
                <i class="fas fa-times text-lg"></i>
            </button>
        </div>

        <div id="sidebar-log-content" class="h-[calc(100vh-80px)] overflow-y-auto font-mono text-xs space-y-1">
            <div class="text-gray-500 text-center pt-8">Select an active session to view the log.</div>
        </div>
    </aside>

    <!-- Overlay (NEW) -->
    <div id="log-sidebar-overlay" class="fixed inset-0 bg-black opacity-0 z-40 hidden transition-opacity duration-300"
        onclick="toggleLogVisibility(selectedSessionId)"></div>

    <script>
        // MAXIMUM number of status messages to display in the log
        const MAX_STATUS_LOG = 10;
        // Polling interval in milliseconds (3 seconds)
        const POLLING_INTERVAL = 3000;

        // --- Data Definitions (State) ---

        // Global state for view navigation
        let currentView = 'LOADING'; // 'DETAIL' or 'NO_SESSIONS'
        let selectedSessionId = null;

        // Global state map to track which session is currently starting (API in progress)
        let startingSessionState = {};

        // Live sessions data (populated on load)
        let liveSessions = [];

        // Stored profiles data will be populated from the API fetch
        let storedProfiles = [];

        // Mock messages pool for the polling simulator
        const mockPollingMessages = [
            "Checked connection status: OK.",
            "Processed 1 new incoming message.",
            "Updated agent state to idle.",
            "Heartbeat signal sent successfully.",
            "Performing routine data sync.",
            "Outreach queue is empty.",
            "Logged successful activity.",
        ];
        let mockPollingMessageIndex = 0;

        // --- Utility Functions ---

        function formatUptime(ms) {
            if (ms < 0) ms = 0;
            const totalSeconds = Math.floor(ms / 1000);
            const hours = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
            const minutes = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
            const seconds = String(totalSeconds % 60).padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        }

        function formatLogEntry(message) {
            const timeString = new Date().toLocaleTimeString('en-US', {
                hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
            });
            return `<span class="font-mono text-[10px] text-gray-400 mr-2">[${timeString}]</span>${message}`;
        }

        function getShortTime() {
             return new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
        }
        
        /**
         * Mocks sending a message and adds a log entry.
         */
        function sendMockMessage() {
            const recipient = document.getElementById('recipient-number').value.trim();
            const message = document.getElementById('chat-input').value.trim();
            
            if (!recipient || !message) {
                // Use a custom modal or console log instead of alert()
                console.log("Cannot send: Recipient or message is empty."); 
                return;
            }

            const session = liveSessions.find(s => s.id === selectedSessionId);
            if (session) {
                const logMessage = `Message sent to ${recipient.substring(0, 15)}...: "${message.substring(0, 30)}..."`;
                session.statusLog.unshift(formatLogEntry(logMessage));
                
                // Clear inputs
                document.getElementById('recipient-number').value = '';
                document.getElementById('chat-input').value = '';
                
                // Update log sidebar immediately if visible
                if (session.isLogVisible) {
                    updateSidebarLogContent(session);
                }
            }
            console.log(`Mock Send: Recipient=${recipient}, Message=${message}`);
        }


        /**
         * Utility function to update the content of the floating log sidebar.
         * @param {object} session - The currently active session object.
         */
        function updateSidebarLogContent(session) {
            const logContainer = document.getElementById('sidebar-log-content');
            if (!logContainer || !session) return;

            if (session.statusLog && session.statusLog.length > 0) {
                // Map logs to HTML and update container
                logContainer.innerHTML = session.statusLog.map(log => `<div class="text-green-400">${log}</div>`).join('');
                // Scroll to the bottom to show the latest entry
                logContainer.scrollTop = logContainer.scrollHeight;
            } else {
                logContainer.innerHTML = `<div class="text-gray-500 text-center pt-8">Log stream established...</div>`;
            }
        }


        // --- Navigation ---

        function navigateTo(view, sessionId = null) {
            // Hide the floating log when navigating to a new view/session
            if (currentView === 'DETAIL' && selectedSessionId) {
                const prevSession = liveSessions.find(s => s.id === selectedSessionId);
                if (prevSession) {
                    prevSession.isLogVisible = false; // Set previous session state to hidden
                }
            }
            // Manually ensure the floating sidebar is visually hidden
            document.getElementById('floating-log-sidebar')?.classList.add('translate-x-full');
            document.getElementById('log-sidebar-overlay')?.classList.add('hidden', 'opacity-0');
            document.getElementById('log-sidebar-overlay')?.classList.remove('opacity-50');

            currentView = view;
            selectedSessionId = sessionId;
            renderApp();
        }

        // --- API Handlers (MOCK ACTIVE) ---

        const MOCK_API_RESPONSE_GET_PROFILES = {
            "success": true,
            "profiles": [
                { "encoded_session_id": "test-001_sales", "base_uuid": "test-001_sales", "profile_name": "Sales Flow", "is_active": false },
                { "encoded_session_id": "e148df19-1cd0-42ea-b9f1-fa3edefd45e5", "base_uuid": "e148df19-1cd0-42ea-b9f1-fa3edefd45e5", "profile_name": "Marketing Campaign 2024", "is_active": false },
                { "encoded_session_id": "3e17e7f2-2981-4ee8-904f-879f06972cc3_acount1", "base_uuid": "3e17e7f2-2981-4ee8-904f-879f06972cc3_acount1", "profile_name": "Weekly Digest Sender", "is_active": false },
                { "encoded_session_id": "55125007-3c63-4d59-bf19-548af3818b1c", "base_uuid": "55125007-3c63-4d59-bf19-548af3818b1c", "profile_name": "HR Onboarding Automation", "is_active": false }
            ],
            "count": 4
        };

        async function fetchLiveSessions() {
            await new Promise(resolve => setTimeout(resolve, 300));
            const NOW = Date.now();
            const MOCK_TIME = '15:52:10';

            const initialLiveSessionsData = [
                {
                    id: 'p3-1',
                    name: 'Dev & Testing',
                    status: 'INITIALIZING',
                    icon: 'fas fa-spinner fa-spin',
                    running: true,
                    startTime: NOW,
                    isPaused: false,
                    isLogVisible: false, // Default hidden for floating sidebar
                    qrCodeUrl: 'https://placehold.co/150x150/000000/ffffff?text=QR+CODE',
                    isQrReady: true,
                    agents: { outreach: true, autoreply: false },
                    statusLog: [
                        `<span class="font-mono text-[10px] text-gray-400 mr-2">[${MOCK_TIME}]</span>Phase 1: Initializing browser environment.`,
                        `<span class="font-mono text-[10px] text-gray-400 mr-2">[${MOCK_TIME}]</span>Phase 2: Awaiting QR Scan...`,
                        `<span class="font-mono text-[10px] text-gray-400 mr-2">[${MOCK_TIME}]</span>Status: High-priority data sync started.`
                    ],
                    activeNumbers: ['+1 (555) 123-4567', '+1 (555) 987-6543', '+1 (555) 111-2222', '+1 (555) 333-4444', '+1 (555) 555-6666', '+1 (555) 777-8888', '+1 (555) 999-0000']
                },
                {
                    id: 'p3-2',
                    name: 'Customer Support Bot',
                    status: 'CONNECTING',
                    icon: 'fas fa-wifi',
                    running: true,
                    startTime: NOW - (2 * 60 * 1000),
                    isPaused: false,
                    isLogVisible: false, // Default hidden for floating sidebar
                    qrCodeUrl: 'https://placehold.co/150x150/000000/ffffff?text=QR+CODE',
                    isQrReady: false,
                    agents: { outreach: false, autoreply: true },
                    statusLog: [
                        `<span class="font-mono text-[10px] text-gray-400 mr-2">[${MOCK_TIME}]</span>Targeting US-based numbers.`,
                        `<span class="font-mono text-[10px] text-gray-400 mr-2">[${MOCK_TIME}]</span>Queue check: 4 pending conversations.`,
                        `<span class="font-mono text-[10px] text-gray-400 mr-2">[${MOCK_TIME}]</span>Agent configuration loaded successfully.`
                    ],
                    activeNumbers: ['+44 20 7946 0999', '+44 7700 900222', '+44 7700 900555']
                },
            ];

            return { "success": true, "sessions": initialLiveSessionsData, "count": initialLiveSessionsData.length };
        }

        async function mockFetchSessionStatus(sessionId) {
            await new Promise(resolve => setTimeout(resolve, 50));
            const logMessage = mockPollingMessages[mockPollingMessageIndex % mockPollingMessages.length];
            mockPollingMessageIndex++;

            let status = 'RUNNING';
            let icon = 'fas fa-circle-notch fa-spin';
            if (sessionId.includes('bot')) {
                status = 'ACTIVE: BOT';
                icon = 'fas fa-robot';
            }
            return {
                "success": true,
                "data": { "status": status, "icon": icon, "last_log": logMessage }
            };
        }

        async function mockCreateSession(profileName, headless) {
            await new Promise(resolve => setTimeout(resolve, 1500));
            const newId = `c${Date.now()}-${Math.floor(Math.random() * 9999)}`;
            const sessionId = `${newId}||${btoa(profileName.replace(/\s/g, '_'))}`;

            const NOW = Date.now();
            const MOCK_TIME = new Date(NOW).toLocaleTimeString('en-US', {
                hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
            });

            // Add new session to liveSessions array
            liveSessions.unshift({
                id: sessionId,
                name: profileName,
                status: 'INITIALIZING',
                icon: 'fas fa-spinner fa-spin',
                running: true,
                startTime: NOW,
                isPaused: false,
                isLogVisible: false, // Default hidden for floating sidebar
                qrCodeUrl: 'https://placehold.co/150x150/000000/ffffff?text=QR+CODE',
                isQrReady: true,
                agents: { outreach: true, autoreply: true }, // Default both agents on for new profile
                statusLog: [
                    `<span class="font-mono text-[10px] text-gray-400 mr-2">[${MOCK_TIME}]</span>Session created and driver requested.`,
                    `<span class="font-mono text-[10px] text-gray-400 mr-2">[${MOCK_TIME}]</span>Awaiting connection status...`
                ],
                activeNumbers: ['+1 (555) 100-2000'] // Default number for new session
            });

            // Set navigation to the new session
            navigateTo('DETAIL', sessionId);

            return { "success": true, "message": "Session created...", "data": { "session_id": sessionId, "profile_name": profileName } };
        }

        async function mockResumeSession(sessionId, headless) {
            await new Promise(resolve => setTimeout(resolve, 1500));
            const profileToResume = storedProfiles.find(p => p.id === sessionId);

            if (!profileToResume) { return { success: false, message: `Session ID '${sessionId}' not found.` }; }

            const NOW = Date.now();
            const MOCK_TIME = new Date(NOW).toLocaleTimeString('en-US', {
                hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
            });

            // Add a new mock live session entry
            liveSessions.unshift({
                id: sessionId,
                name: profileToResume.name,
                status: 'INITIALIZING',
                icon: 'fas fa-spinner fa-spin',
                running: true,
                startTime: NOW,
                isPaused: false,
                isLogVisible: false, // Default hidden for floating sidebar
                qrCodeUrl: 'https://placehold.co/150x150/000000/ffffff?text=QR+CODE',
                isQrReady: false,
                agents: { outreach: true, autoreply: true }, // Default both agents on when resuming
                statusLog: [
                    `<span class="font-mono text-[10px] text-gray-400 mr-2">[${MOCK_TIME}]</span>Session resume requested.`,
                    `<span class="font-mono text-[10px] text-gray-400 mr-2">[${MOCK_TIME}]</span>Starting browser driver in ${headless ? 'headless' : 'visible'} mode.`
                ],
                activeNumbers: ['+1 (555) 000-0000'] // Default number for resumed session
            });
            // Set navigation to the new session
            navigateTo('DETAIL', sessionId);


            return { "success": true, "message": "Session resumed successfully.", "data": { "session_id": sessionId } };
        }

        async function mockStopSession(sessionId) {
            const index = liveSessions.findIndex(s => s.id === sessionId);
            if (index !== -1) {
                const sessionToStop = liveSessions.splice(index, 1)[0];
                const isAlreadyStored = storedProfiles.some(p => p.id === sessionId);
                if (!isAlreadyStored) {
                     storedProfiles.push({ encoded_session_id: sessionId, base_uuid: sessionId, profile_name: sessionToStop.name, is_active: false });
                }
            }

            // New navigation logic: Go to the first remaining session or the No Sessions view
            if (liveSessions.length > 0) {
                 navigateTo('DETAIL', liveSessions[0].id);
            } else {
                 navigateTo('NO_SESSIONS');
            }

            return { "success": true, "message": "Session stopped (profile saved)", "data": null };
        }

        // Mock function to toggle pause state
        async function togglePauseSession(sessionId) {
            const sessionIndex = liveSessions.findIndex(s => s.id === sessionId);
            if (sessionIndex !== -1) {
                liveSessions[sessionIndex].isPaused = !liveSessions[sessionIndex].isPaused;
                // Add a log entry for the pause/resume action
                const action = liveSessions[sessionIndex].isPaused ? 'paused' : 'resumed';
                liveSessions[sessionIndex].statusLog.unshift(formatLogEntry(`Session logic ${action}.`));
            }
            // Re-render to update the button and status
            renderApp();
            return { "success": true, "message": `Session ${sessionId} ${action}.` };
        }


        /**
         * Toggles the visibility of the floating log sidebar.
         * @param {string} sessionId - The ID of the current session to update state for.
         */
        function toggleLogVisibility(sessionId) {
            const session = liveSessions.find(s => s.id === sessionId);
            if (!session) return;
            
            session.isLogVisible = !session.isLogVisible;

            const sidebar = document.getElementById('floating-log-sidebar');
            const overlay = document.getElementById('log-sidebar-overlay');
            const toggleBtn = document.getElementById(`log-toggle-btn-${sessionId}`);

            if (session.isLogVisible) {
                // Show Sidebar
                sidebar.classList.remove('translate-x-full');
                overlay.classList.remove('hidden', 'opacity-0');
                overlay.classList.add('opacity-50');
                if (toggleBtn) {
                    toggleBtn.classList.remove('text-gray-500', 'border-gray-300', 'hover:bg-gray-100');
                    toggleBtn.classList.add('text-blue-600', 'border-blue-400', 'hover:bg-blue-100');
                }
                // Populate log content when opening
                updateSidebarLogContent(session);
            } else {
                // Hide Sidebar
                sidebar.classList.add('translate-x-full');
                overlay.classList.remove('opacity-50');
                overlay.classList.add('hidden', 'opacity-0');
                if (toggleBtn) {
                    toggleBtn.classList.add('text-gray-500', 'border-gray-300', 'hover:bg-gray-100');
                    toggleBtn.classList.remove('text-blue-600', 'border-blue-400', 'hover:bg-blue-100');
                }
            }
            
            // Add a log entry for the action (optional, but good for tracking)
            const action = session.isLogVisible ? 'shown' : 'hidden';
            session.statusLog.unshift(formatLogEntry(`Log console visibility toggled to ${action}.`));
        }

        // New function to toggle agent state
        function toggleAgent(sessionId, agentType) {
            const session = liveSessions.find(s => s.id === sessionId);
            if (session && session.agents && session.agents.hasOwnProperty(agentType)) {
                session.agents[agentType] = !session.agents[agentType];

                // Add a log entry for the action
                const status = session.agents[agentType] ? 'ACTIVATED' : 'DEACTIVATED';
                const agentName = agentType.charAt(0).toUpperCase() + agentType.slice(1);
                session.statusLog.unshift(formatLogEntry(`${agentName} Agent ${status}.`));

                // Re-render only the current detail view for responsiveness
                renderApp();
            }
        }

        async function fetchStoredProfiles() {
            try {
                const response = MOCK_API_RESPONSE_GET_PROFILES;
                if (response.success) {
                    storedProfiles = response.profiles.map(p => ({
                        id: p.encoded_session_id, name: p.profile_name, isActive: p.is_active
                    }));
                }
            } catch (error) {
                console.error("Error in fetchStoredProfiles:", error);
            }
            // Only render stored profiles if we are in the NO_SESSIONS view
            if (currentView === 'NO_SESSIONS') {
                renderStoredProfiles();
            }
        }


        // --- Rendering Functions ---

        /**
         * Renders the simplified stored profile list within the No Sessions View.
         */
        function renderStoredProfiles() {
            const storedGrid = document.getElementById('stored-profiles-grid');
            if (!storedGrid) return; // Guard against detail view

            const activeIds = new Set(liveSessions.map(s => s.id));
            const availableProfiles = storedProfiles.filter(p => !activeIds.has(p.id));

            if (availableProfiles.length === 0) {
                storedGrid.innerHTML = `<p class="text-xs text-gray-400 py-2">No profiles saved.</p>`;
                return;
            }

            const simpleCardHtml = (profile) => {
                const isStarting = startingSessionState[profile.id] || false;
                return `
                    <div id="simple-card-${profile.id}"
                        class="bg-gray-100 p-2 rounded-sm transition duration-150 flex justify-between items-center cursor-pointer border border-gray-300 ${isStarting ? 'starting-session' : 'hover:bg-gray-200 hover:border-gray-500'}"
                        onclick="${isStarting ? '' : `attemptResumeSession('${profile.id}', true)`}">
                        <span class="text-xs font-medium text-gray-800 truncate">${profile.name}</span>
                        <i class="${isStarting ? 'fas fa-spinner fa-spin text-gray-600' : 'fas fa-play text-gray-500'} text-xs ml-2"></i>
                    </div>
                `;
            };

            storedGrid.innerHTML = availableProfiles.map(simpleCardHtml).join('');
        }

        function renderNoSessionsView() {
            return `
                
<header class="flex justify-between items-center px-6 py-4 border-b border-gray-300 bg-white rounded-sm shadow-md">
                    <div class="flex items-center space-x-4">
                        <h1 class="text-xl font-semibold text-gray-900 tracking-tight">AGENT.OS - No Active Sessions</h1>
                    </div>
                    
<button id="new-profile-btn"
                        class="action-btn bg-gray-900 text-white hover:bg-black shadow-lg transition-transform duration-150 border border-gray-900"
                        title="Create New Profile" onclick="document.getElementById('new-profile-modal').classList.remove('hidden')">
                        <i class="fas fa-plus text-lg"></i>
                    </button>
                </header>

                <div class="p-6 pt-0 min-h-[75vh] flex items-center justify-center">
                    <div class="text-center p-8 bg-gray-50 border-2 border-gray-300 card-base max-w-sm shadow-xl">
                        <i class="fas fa-exclamation-triangle text-4xl text-gray-500 mb-4"></i>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">No Sessions Found</h3>
                        <p class="text-gray-600 mb-4">Launch an agent using a new profile or resume a stored session below.</p>
                        <button onclick="document.getElementById('new-profile-modal').classList.remove('hidden')"
                            class="px-4 py-2 text-sm font-medium bg-gray-800 text-white rounded-sm hover:bg-black transition duration-150 border-2 border-gray-800">
                            <i class="fas fa-rocket mr-2"></i> Launch New Profile
                        </button>
                        
                        
<div id="stored-profiles-container" class="mt-4">
                            <h4 class="text-xs font-semibold text-gray-500 mb-2 border-t pt-2 mt-4 border-gray-300">Stored Profiles</h4>
                            <div id="stored-profiles-grid" class="grid grid-cols-1 gap-2 text-xs">
                                <p class="text-gray-400">Loading stored profiles...</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderSessionDetailView(session) {
            const uptime = formatUptime(Date.now() - session.startTime);
            const isPaused = session.isPaused;
            const isLogVisible = session.isLogVisible;
            const detailedStatus = session.status.toUpperCase().replace(':', ' - ');

            return `
                
<header class="flex justify-between items-center px-4 py-3 border-b border-gray-300 bg-white rounded-t-sm shadow-md">
                    <div class="flex justify-between w-full items-center space-x-4">
                        
                        <h1 class="text-xl font-semibold text-gray-900 tracking-tight">${session.name}</h1>

                        
<div class="flex items-center space-x-3">
                            <!-- Minimal Stop Button (Squared, Icon Only) -->
                            <button onclick="stopSession('${session.id}')"
                                class="action-btn bg-white text-red-600 border-2 border-red-500 hover:bg-red-100"
                                title="Stop Session & Save Profile">
                                <i class="fas fa-power-off text-sm"></i>
                            </button>

                            <!-- Minimal Pause/Resume Button (Squared, Icon Only) -->
                            <button onclick="togglePauseSession('${session.id}')"
                                class="action-btn bg-white ${isPaused ? 'text-green-600 border-2 border-green-500 hover:bg-green-100' : 'text-gray-700 border-2 border-gray-500 hover:bg-gray-100'}"
                                title="${isPaused ? 'Resume Session Logic' : 'Pause Session Logic'}">
                                <i class="fas ${isPaused ? 'fa-play' : 'fa-pause'} text-sm"></i>
                            </button>

                            <!-- Minimal Log Toggle Button (Squared, Icon Only) - Controls the FLOATING SIDEBAR -->
                            <button onclick="toggleLogVisibility('${session.id}')" id="log-toggle-btn-${session.id}"
                                class="action-btn bg-white ${isLogVisible ? 'text-blue-600 border-2 border-blue-500 hover:bg-blue-100' : 'text-gray-500 border-2 border-gray-400 hover:bg-gray-100'}"
                                title="${isLogVisible ? 'Hide Live Log' : 'Show Live Log'}">
                                <i class="fas fa-terminal text-sm"></i>
                            </button>
                        </div>
                    </div>
                </header>
<div class="p-4 pt-0  flex ">
                 <div class=" h-full border shadow-lg ">

                     <div class=" bg-white p-3 shadow-lg border border-gray-300 mb-4 rounded-sm">
                        <div class="flex justify-between items-center space-x-6">
                            
                            <!-- Outreach Agent Toggle -->
                            <div class="flex-1 flex justify-between items-center border-r pr-6 border-gray-200">
                                <span class="text-sm font-medium text-gray-700">Outreach Agent</span>
                                <button onclick="toggleAgent('${session.id}', 'outreach')" id="outreach-toggle-${session.id}"
                                    class="agent-toggle-btn w-10 h-6 flex items-center transition duration-200 p-0.5 rounded-sm ${session.agents.outreach ? 'bg-green-600' : 'bg-gray-300'}">
                                    <div
                                        class="w-5 h-5 bg-white rounded-sm shadow-md transform transition-transform duration-200 ${session.agents.outreach ? 'translate-x-4' : 'translate-x-0'}">
                                    </div>
                                </button>
                            </div>
                            
                            <!-- Auto-Reply Agent Toggle -->
                            <div class="flex-1 flex justify-between items-center pl-6">
                                <span class="text-sm font-medium text-gray-700">Auto-Reply Agent</span>
                                <button onclick="toggleAgent('${session.id}', 'autoreply')" id="autoreply-toggle-${session.id}"
                                    class="agent-toggle-btn w-10 h-6 flex items-center transition duration-200 p-0.5 rounded-sm ${session.agents.autoreply ? 'bg-green-600' : 'bg-gray-300'}">
                                    <div
                                        class="w-5 h-5 bg-white rounded-sm shadow-md transform transition-transform duration-200 ${session.agents.autoreply ? 'translate-x-4' : 'translate-x-0'}">
                                    </div>
                                </button>
                            </div>
                            
                         
                        </div>
                    </div>
                      <!-- Main Content Area: Vertical Number List and Chat Inputs -->
                        <div class="flex-1 bg-white rounded-sm shadow-xl border border-gray-300 flex flex-col h-[70vh]">

this element will those list of number  when the 
                    </div>





                    
                    </div>
<div class="p-4 pt-0 ">
                    
                    
                   


                    
                        <!-- Main Content Area: Vertical Number List and Chat Inputs -->
                        <div class="flex-1 bg-white rounded-sm shadow-xl border border-gray-300 flex flex-col h-full">
                            
                            <!-- Header -->
                            <div class="p-2 border-b border-gray-300 bg-gray-100 flex justify-between items-center flex-shrink-0">
                                <span class="text-sm font-medium text-gray-800">
                                    <i class="fas fa-hashtag mr-2 text-blue-500"></i> Active WhatsApp Numbers (${session.activeNumbers.length})
                                </span>
                                <span class="text-xs text-gray-400">Status: ${detailedStatus}</span>
                            </div>

                            <!-- Vertical Number List Container (Now scrollable) -->
                            <div class="p-3 overflow-y-auto flex-1 flex flex-col space-y-2">
                                ${session.activeNumbers.map(number => `
                                    <div class="numbers_item flex-shrink-0 bg-gray-100 p-2 rounded-sm shadow-sm border border-gray-200 transition duration-150 hover:bg-gray-200 cursor-pointer text-sm font-mono text-gray-700">
                                        <i class="fas fa-mobile-alt mr-2 text-blue-500"></i> ${number}
                                    </div>
                                `).join('')}
                            </div>

                            <!-- New Messaging Input Section -->
                            <div class="p-3 border-t border-gray-300 flex-shrink-0 bg-gray-100">
                                <div class="mb-3">
                                    <label for="recipient-number" class="block text-xs font-medium text-gray-600 mb-1">Recipient Number</label>
                                    <input type="text" id="recipient-number" placeholder="+1 (555) 555-5555"
                                           class="w-full px-3 py-2 border-2 border-gray-400 rounded-sm focus:ring-gray-900 focus:border-gray-900 text-sm shadow-inner">
                                </div>
                                <div class="flex space-x-2">
                                    <input type="text" id="chat-input" placeholder="Type your message here..."
                                           class="flex-1 px-3 py-2 border-2 border-gray-400 rounded-sm focus:ring-gray-900 focus:border-gray-900 text-sm shadow-inner">
                                    <button onclick="sendMockMessage()"
                                            class="bg-gray-900 text-white px-4 py-2 rounded-sm hover:bg-black transition duration-150 flex-shrink-0 border-2 border-gray-900 shadow-md">
                                        <i class="fas fa-paper-plane mr-1"></i> Send
                                    </button>
                                </div>
                            </div>
                        </div>

                    
                </div>
                </div>

            `;
        }


        // --- Interaction Handlers ---

        async function attemptResumeSession(sessionId, headless = true) {
            if (startingSessionState[sessionId]) return;

            startingSessionState[sessionId] = true;
            renderStoredProfiles();

            try {
                const response = await mockResumeSession(sessionId, headless);

                if (response.success) {
                    // mockResumeSession now handles updating liveSessions and navigating
                    // No need for explicit navigation here, as it's handled in mockResumeSession
                } else {
                    console.error("Resume failed:", response.message);
                }
            } catch (error) {
                console.error("Network error during resume:", error);
            } finally {
                delete startingSessionState[sessionId];
                // Since successful resume calls navigateTo('DETAIL'), we only need to re-render if it failed
                if (currentView === 'NO_SESSIONS') {
                    renderStoredProfiles();
                }
            }
        }

        async function stopSession(sessionId) {
            const result = await mockStopSession(sessionId);
            if (!result.success) {
                console.error("Failed to stop session:", result.message);
            }
            // Navigation handled inside mockStopSession
        }


        // --- Polling & Initialization ---

        function updateUptimes() {
             // Update detail view uptime
             if (currentView === 'DETAIL' && selectedSessionId) {
                const session = liveSessions.find(s => s.id === selectedSessionId);
                const uptimeSpan = document.getElementById(`detail-uptime-${selectedSessionId}`);
                if (session && uptimeSpan && session.running) {
                    uptimeSpan.textContent = formatUptime(Date.now() - session.startTime);
                }
             }
        }

        async function pollLiveSessionStatuses() {
            updateUptimes();

            // Only poll if we have live sessions
            if (liveSessions.length === 0) return;

            for (const session of liveSessions) {
                try {
                    const response = await mockFetchSessionStatus(session.id);

                    if (response.success) {
                        const { status, icon, last_log } = response.data;
                        session.status = status;
                        session.icon = icon;

                        const logEntry = formatLogEntry(last_log);
                        if (!session.statusLog.includes(logEntry)) {
                            session.statusLog.unshift(logEntry);
                            if (session.statusLog.length > MAX_STATUS_LOG) {
                                session.statusLog.pop();
                            }
                        }

                        // Optimization: Directly update the log content if on this session's detail view AND log is visible
                        if (currentView === 'DETAIL' && selectedSessionId === session.id) {
                            const currentSession = liveSessions.find(s => s.id === selectedSessionId);
                            if (currentSession.isLogVisible) {
                                updateSidebarLogContent(currentSession); // Use the utility function to update the floating log
                            }
                        }
                    } else {
                        console.warn(`Failed to get status for ${session.id}: ${response.message}`);
                    }
                } catch (error) {
                    console.error(`Error polling status for ${session.id}:`, error);
                }
            }
        }

        function renderApp() {
            const appContainer = document.getElementById('app');
            if (currentView === 'LOADING') {
                 // Placeholder, already set in the body
            } else if (currentView === 'NO_SESSIONS') {
                appContainer.innerHTML = renderNoSessionsView();
                renderStoredProfiles(); // Render stored profiles immediately after view is set up
            } else if (currentView === 'DETAIL' && selectedSessionId) {
                const session = liveSessions.find(s => s.id === selectedSessionId);
                if (session) {
                    appContainer.innerHTML = renderSessionDetailView(session);

                    // Ensure the floating log button reflects the state immediately after rendering the header
                    // We call it twice to ensure the visual state of the button/sidebar is correctly synchronized with session.isLogVisible
                    toggleLogVisibility(session.id); 
                    toggleLogVisibility(session.id); 
                } else {
                    navigateTo('NO_SESSIONS');
                }
            }
        }

        async function init() {
            // 1. Fetch initial data
            const liveResponse = await fetchLiveSessions();
            if (liveResponse.success) {
                liveSessions = liveResponse.sessions;
            }

            // 2. Determine initial view
            if (liveSessions.length > 0) {
                currentView = 'DETAIL';
                selectedSessionId = liveSessions[0].id;
            } else {
                currentView = 'NO_SESSIONS';
            }

            // 3. Fetch stored profiles (needed for NO_SESSIONS view)
            await fetchStoredProfiles();

            // 4. Render the initial view
            renderApp();

            // 5. Start the polling timer
            setInterval(pollLiveSessionStatuses, POLLING_INTERVAL);
        }

        // --- Modal Handlers (Adapted for Monochrome) ---
        const modal = document.getElementById('new-profile-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const newProfileForm = document.getElementById('new-profile-form');
        const modalMessage = document.getElementById('modal-message');

        if (closeModalBtn) {
            closeModalBtn.addEventListener('click', () => {
                modal.classList.add('hidden');
            });
        }

        if (newProfileForm) {
            newProfileForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const formData = new FormData(newProfileForm);
                const profileName = formData.get('profileName');
                const launchMode = formData.get('launchMode');
                const headless = launchMode === 'headless';

                const submitButton = newProfileForm.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                submitButton.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> Starting...`;
                modalMessage.classList.add('hidden');

                try {
                    const response = await mockCreateSession(profileName, headless);

                    if (response.success) {
                        modal.classList.add('hidden');
                        // mockCreateSession now handles updating liveSessions and navigating to the new session
                    } else {
                        modalMessage.textContent = response.message || 'Failed to create session.';
                        modalMessage.classList.remove('hidden');
                    }
                } catch (error) {
                    modalMessage.textContent = 'Network error: Could not reach the API.';
                    modalMessage.classList.remove('hidden');
                    console.error("Create session error:", error);
                } finally {
                    submitButton.disabled = false;
                    submitButton.innerHTML = `<i class="fas fa-rocket mr-2"></i> Launch`;
                }
            });
        }
        // Initialize the app when the window loads
        window.onload = init;
    </script>
</body>

</html>