<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Agent Panel Compacted</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer">
    <style>
        /* Setup for Inter font and light theme body styles */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9f9f9;
            /* bg-zinc-50 - Very Light Gray */
            min-height: 100vh;
            padding: 0.5rem;
        }

        /* Base Card Styling (Sharp corners internally) */
        .card-base {
            transition: all 0.3s ease-in-out;
            border-radius: 0;
            /* Sharp corners internally */
            border: 1px solid #d1d5db;
            /* border-gray-300 */
        }

        .card-base:hover {
            transform: translateY(-1px);
        }

        /* Smaller, status dot - kept circular for functional appearance */
        .status-dot {
            width: 8px;
            height: 8px;
            min-width: 8px;
            min-height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        /* Action buttons refined for consistency and modern look (Sharp corners) */
        .action-btn {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0;
            /* Sharp corners */
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.05), 0 1px 2px -1px rgba(0, 0, 0, 0.05);
        }

        .action-btn:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.08), 0 2px 4px -2px rgba(0, 0, 0, 0.08);
        }

        /* CHAT BUBBLE STYLES */
        .chat-bubble {
            max-width: 75%;
            padding: 8px 12px;
            border-radius: 6px;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        .chat-bubble-self {
            background-color: #dcf8c6;
            /* WhatsApp Green */
            align-self: flex-end;
            margin-left: auto;
        }

        .chat-bubble-other {
            background-color: #ffffff;
            /* White */
            border: 1px solid #e5e7eb;
            /* border-gray-200 */
            align-self: flex-start;
        }

        /* Chat list item non-interactive styling (Allowing programmatic highlight) */
        .numbers_item {
            cursor: default !important;
            transition: background-color 0.15s, border-left 0.15s;
        }

        .numbers_item:hover {
            background-color: initial !important;
        }

        /* --- CSS-ONLY INTERACTION LOGIC (Only for Log Sidebar) --- */
        #log-toggle-check {
            display: none;
        }

        #log-toggle-check:checked~#floating-log-sidebar {
            --tw-translate-x: 0px;
            transform: translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y));
        }

        @media (min-width: 640px) {
            .sm\:w-96 {
                width: 24rem;
            }
        }
    </style>
</head>

<body class="bg-zinc-50">

    <!-- Main Application Container (Minimal rounding applied here) -->
    <div id="app" class="max-w-6xl mx-auto bg-white rounded-sm shadow-xl flex flex-col h-[90vh] border border-gray-400">

        <!-- Header: Consistent Horizontal Padding (px-4) -->
        <header
            class="flex justify-between items-center px-4 py-3 border-b border-gray-300 bg-gray-100 rounded-t-sm flex-shrink-0">
            <div class="flex justify-between w-full items-center space-x-3">
                <h1 class="text-lg font-semibold text-gray-900 tracking-tight flex items-center">
                    <i class="fab fa-whatsapp text-gray-800 mr-2 text-xl"></i>Dev & Testing Panel
                </h1>

                <div class="flex items-center space-x-2">
                    <button class="action-btn bg-white text-gray-800 border border-gray-400 hover:bg-gray-200"
                        title="Stop Session & Save Profile">
                        <i class="fas fa-power-off text-xs"></i>
                    </button>
                    <button class="action-btn bg-white text-gray-700 border border-gray-300 hover:bg-gray-50"
                        title="Pause Session Logic">
                        <i class="fas fa-pause text-xs"></i>
                    </button>
                    <label for="log-toggle-check"
                        class="action-btn bg-gray-900 border-2 border-gray-900 text-white hover:bg-black cursor-pointer"
                        title="Toggle Live Log">
                        <i class="fas fa-terminal text-xs"></i>
                    </label>
                </div>
            </div>
        </header>

        <!-- Main Content Area: Flex 1 -->
        <div class="flex flex-1 overflow-hidden">

            <!-- LEFT SIDEBAR -->
            <div id="leftsidebar" class="w-96 bg-zinc-50 flex flex-col flex-shrink-0 space-y-3 py-3">

                <!-- Sidebar Header: Framed with border, padding, and margin -->
                <div
                    class="px-4 py-3 mx-4 border border-gray-300 rounded-sm bg-gray-100 flex justify-between items-center flex-shrink-0 shadow-sm">
                    <span class="text-sm font-semibold text-gray-800 flex items-center">
                        <i class="fas fa-hashtag mr-2 text-gray-800"></i> Active Numbers <span
                            id="active-numbers-count">(Loading)</span>
                    </span>
                    <span class="text-xs text-gray-500 font-medium">
                        <!-- Polling Status Target -->
                        <span class="status-dot bg-red-500 mr-1"></span> <span id="session-status-text">IDLE</span>
                    </span>
                </div>

                <!-- Number List (Scrollable) -->
                <div id="chat-list-container"
                    class="overflow-y-auto flex-1 flex flex-col space-y-0 bg-white border border-gray-300 mx-4 p-1 mb-2 shadow-inner rounded-sm">
                    <!-- Dynamic chat list items will be injected here by JavaScript -->
                    <div class="p-4 text-center text-sm text-gray-500">
                        <i class="fas fa-spinner fa-spin mr-2"></i>Loading chats...
                    </div>
                </div>

                <!-- Sidebar Footer (Minimalistic Add Number Input) -->
                <div class="px-4 py-3 mx-4 border border-gray-300 rounded-sm flex-shrink-0 bg-gray-100 shadow-sm">

                    <div class="flex items-end space-x-2">

                        <!-- Recipient Number Input (Takes max space) -->
                        <div class="flex-1">
                            <label for="recipient-number" class="block text-xs font-medium text-gray-600 mb-1">Add New
                                Chat Number</label>
                            <input type="text" id="recipient-number" placeholder="+1 (555) 555-5555"
                                class="w-full px-2 py-1 border border-gray-300 rounded-sm focus:ring-gray-900 focus:border-gray-900 text-sm shadow-inner">
                        </div>

                        <!-- Add Button (Square, Black accent) -->
                        <button id="add-number-btn"
                            class="w-8 h-8 bg-gray-900 text-white rounded-sm hover:bg-black transition duration-150 flex-shrink-0 border border-gray-900 shadow-sm flex items-center justify-center"
                            title="Add Number to Active List">
                            <!-- Icon size adjusted to fit nicely in the square -->
                            <i class="fas fa-plus text-sm"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right Main Panel (Takes remaining space, has consistent vertical padding (py-3)) -->
            <div id="main-panel" class="flex-1 px-4 py-3 flex flex-col space-y-3 bg-zinc-50 overflow-y-auto">

                <!-- Agent Toggles Card - Compacted Layout -->
                <div class="bg-white p-2 shadow-sm card-base border-gray-300">
                    <div class="flex flex-col space-y-2">

                        <!-- Outreach Agent Control Section (Compact) -->
                        <div class="w-full flex justify-between items-center pb-2 border-b border-gray-200">
                            <span class="text-sm font-semibold text-gray-700 flex items-center whitespace-nowrap">
                                <i class="fas fa-bullhorn mr-2 text-base text-gray-700"></i> Outreach Agent
                            </span>
                            <div class="flex items-center space-x-2">
                                <!-- TOGGLE BUTTON (Play/Pause) -->
                                <button id="outreach-toggle-btn" onclick="toggleAgentStatus('outreach')"
                                    class="text-green-600 hover:text-green-700 transition duration-150 p-1 rounded-sm"
                                    title="Start Outreach Agent">
                                    <i class="fas fa-play text-base"></i>
                                </button>
                                <!-- STOP BUTTON -->
                                <button id="outreach-stop-btn" onclick="stopAgent('outreach')"
                                    class="text-red-500 hover:text-red-600 transition duration-150 p-1 rounded-sm"
                                    title="Stop Outreach Agent">
                                    <i class="fas fa-stop text-base"></i>
                                </button>
                                <!-- SETTINGS BUTTON -->
                                <button id="outreach-settings-btn"
                                    class="text-gray-500 hover:text-gray-700 transition duration-150 p-1 rounded-sm"
                                    title="Outreach Settings">
                                    <i class="fas fa-cog text-base"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Auto-Reply Agent Control Section (Compact) -->
                        <div class="w-full flex justify-between items-center pt-1">
                            <span class="text-sm font-semibold text-gray-700 flex items-center whitespace-nowrap">
                                <i class="fas fa-robot mr-2 text-base text-gray-700"></i> Auto-Reply Agent
                            </span>
                            <div class="flex items-center space-x-2">
                                <!-- TOGGLE BUTTON (Play/Pause) -->
                                <button id="autoreply-toggle-btn" onclick="toggleAgentStatus('autoreply')"
                                    class="text-green-600 hover:text-green-700 transition duration-150 p-1 rounded-sm"
                                    title="Start Auto-Reply Agent">
                                    <i class="fas fa-play text-base"></i>
                                </button>
                                <!-- STOP BUTTON -->
                                <button id="autoreply-stop-btn" onclick="stopAgent('autoreply')"
                                    class="text-red-500 hover:text-red-600 transition duration-150 p-1 rounded-sm"
                                    title="Stop Auto-Reply Agent">
                                    <i class="fas fa-stop text-base"></i>
                                </button>
                                <!-- SETTINGS BUTTON -->
                                <button id="autoreply-settings-btn"
                                    class="text-gray-500 hover:text-gray-700 transition duration-150 p-1 rounded-sm"
                                    title="Auto-Reply Settings">
                                    <i class="fas fa-cog text-base"></i>
                                </button>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Chatbot Interface Panel (Replaces Dashboard, Takes remaining space) -->
                <div class="flex-1 bg-white shadow-sm card-base border-gray-300 flex flex-col overflow-hidden">

                    <!-- Chat History (Scrollable Area) -->
                    <div id="chat-history" class="flex-1 flex flex-col overflow-hidden">
                        <!-- Chat messages or empty state will be dynamically added here -->
                    </div>

                    <!-- Chat Input Area (Fixed at bottom) -->
                    <div class="flex-shrink-0 p-3 border-t border-gray-200 bg-gray-50">
                        <div class="flex items-center space-x-2">
                            <!-- Input Field -->
                            <input type="text" id="chat-message-input"
                                placeholder="Type a message to the active chat..."
                                class="flex-1 px-4 py-2 border border-gray-300 rounded-sm focus:ring-gray-900 focus:border-gray-900 text-sm shadow-inner">

                            <!-- Send Button (Perfect Square) -->
                            <button id="chat-send-btn"
                                class="w-10 h-10 bg-gray-900 text-white rounded-sm hover:bg-black transition duration-150 flex-shrink-0 border border-gray-900 shadow-md flex items-center justify-center"
                                title="Send Message">
                                <i class="fas fa-paper-plane text-base"></i>
                            </button>
                        </div>
                    </div>
                </div>

            </div>
            <!-- End Right Main Panel -->

        </div>
        <!-- End Main Content Area -->

    </div>
    <!-- End App Container -->

    <!-- --- SETTINGS MODAL --- -->
    <div id="settings-modal"
        class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center hidden" role="dialog"
        aria-modal="true">
        <div class="bg-white w-full max-w-lg p-6 shadow-2xl rounded-sm border border-gray-300">

            <!-- Modal Header -->
            <div class="flex justify-between items-center pb-3 border-b border-gray-200 mb-4">
                <h3 id="modal-title" class="text-xl font-bold text-gray-900">Agent Settings</h3>
                <button onclick="closeModal()"
                    class="text-gray-400 hover:text-gray-700 transition duration-150 p-1 focus:outline-none">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>

            <!-- Modal Content Wrapper (Used to switch content dynamically) -->
            <div id="modal-content-wrapper">

                <!-- 1. Outreach Agent Settings Content -->
                <div id="outreach-settings-content" class="space-y-4 hidden">
                    <p class="text-sm text-gray-600">Configure the list of recipients and the initial message for the
                        bulk outreach agent.</p>

                    <div>
                        <label for="outreach-numbers" class="block text-sm font-medium text-gray-700 mb-1">Recipient
                            Numbers (Comma-separated)</label>
                        <textarea id="outreach-numbers" rows="3" placeholder="+15551234567, +15559876543, ..."
                            class="w-full px-3 py-2 border border-gray-300 rounded-sm focus:ring-gray-900 focus:border-gray-900 text-sm shadow-inner"></textarea>
                    </div>

                    <div>
                        <label for="outreach-message" class="block text-sm font-medium text-gray-700 mb-1">Message
                            Template</label>
                        <textarea id="outreach-message" rows="3"
                            placeholder="Hi there, checking if you received our last email..."
                            class="w-full px-3 py-2 border border-gray-300 rounded-sm focus:ring-gray-900 focus:border-gray-900 text-sm shadow-inner"></textarea>
                    </div>

                    <div class="pt-2 flex justify-end space-x-3">
                        <button onclick="closeModal()"
                            class="px-4 py-2 bg-gray-200 text-gray-700 text-sm font-medium rounded-sm hover:bg-gray-300 transition duration-150">Cancel</button>
                        <button onclick="saveOutreachSettings()"
                            class="px-4 py-2 bg-gray-900 text-white text-sm font-medium rounded-sm hover:bg-black transition duration-150">Save
                            & Close</button>
                    </div>
                </div>

                <!-- 2. Auto-Reply Agent Settings Content -->
                <div id="autoreply-settings-content" class="space-y-4 hidden">
                    <p class="text-sm text-gray-600">Define the core instructions and persona for the AI Auto-Reply
                        Agent.</p>

                    <div>
                        <label for="autoreply-instructions" class="block text-sm font-medium text-gray-700 mb-1">Agent
                            Instructions / Prompt</label>
                        <textarea id="autoreply-instructions" rows="8"
                            placeholder="Act as a friendly customer support representative for a small coffee business. Keep responses concise and always use emojis."
                            class="w-full px-3 py-2 border border-gray-300 rounded-sm focus:ring-gray-900 focus:border-gray-900 text-sm shadow-inner"></textarea>
                    </div>

                    <div class="pt-2 flex justify-end space-x-3">
                        <button onclick="closeModal()"
                            class="px-4 py-2 bg-gray-200 text-gray-700 text-sm font-medium rounded-sm hover:bg-gray-300 transition duration-150">Cancel</button>
                        <button onclick="saveAutoreplySettings()"
                            class="px-4 py-2 bg-gray-900 text-white text-sm font-medium rounded-sm hover:bg-black transition duration-150">Save
                            & Close</button>
                    </div>
                </div>

            </div>
        </div>
    </div>


    <!-- Floating Log Sidebar (Retains dark theme for console contrast) -->
    <input type="checkbox" id="log-toggle-check">
    <aside id="floating-log-sidebar"
        class="fixed top-0 right-0 h-full w-full sm:w-96 bg-gray-900 text-gray-200 shadow-2xl z-50 p-6 transform transition-transform duration-300 ease-in-out border-l-4 border-gray-700 translate-x-full">

        <div class="flex justify-between items-center mb-4 pb-2 border-b-2 border-gray-700">
            <h3 class="text-xl font-bold text-gray-100 flex items-center">
                <i class="fas fa-terminal mr-2 text-gray-400"></i> Real-Time Log Console
            </h3>
            <label for="log-toggle-check"
                class="text-gray-400 hover:text-white transition duration-150 p-1 rounded-sm hover:bg-gray-800 focus:outline-none cursor-pointer">
                <i class="fas fa-times text-lg"></i>
            </label>
        </div>

        <div id="sidebar-log-content" class="h-[calc(100vh-80px)] overflow-y-auto font-mono text-xs space-y-1">
            <div class="text-green-400">
                <span class="font-mono text-[10px] text-gray-400 mr-2">[15:52:10]</span>MOCK: Log Initialized. Polling
                will start after session verification.
            </div>
        </div>
    </aside>

    <script>
        let mockChats = [];
        let totalChatCount = 0;
        let currentSession = null; // Global session object
        const MAX_STATUS_LOG = 10;
        let highlightedChatId = null; // New state variable for chat highlighting
        let currentChatHistory = []; // NEW: Stores history of the currently displayed chat

        // New state for agent control
        let agentStatus = {
            outreach: { isRunning: false, name: 'Outreach Agent' },
            autoreply: { isRunning: false, name: 'Auto-Reply Agent' }
        };

        // Constants for DOM elements
        const chatHistoryContainer = document.getElementById('chat-history');
        const chatListContainer = document.getElementById('chat-list-container');
        const countElement = document.getElementById('active-numbers-count');
        const chatInput = document.getElementById('chat-message-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const addNumberBtn = document.getElementById('add-number-btn');
        const logContentContainer = document.getElementById('sidebar-log-content');
        const statusDot = document.querySelector('.status-dot');
        const statusText = document.getElementById('session-status-text');

        // Modal Elements
        const settingsModal = document.getElementById('settings-modal');
        const modalTitle = document.getElementById('modal-title');
        const outreachSettingsContent = document.getElementById('outreach-settings-content');
        const autoreplySettingsContent = document.getElementById('autoreply-settings-content');

        // Agent Button Elements
        const outreachToggleBtn = document.getElementById('outreach-toggle-btn');
        const autoreplyToggleBtn = document.getElementById('autoreply-toggle-btn');


        // --- Agent Control Functions ---

        /**
         * Toggles the running status of an agent (Start/Pause) and calls the necessary API endpoint.
         * Includes validation checks using localStorage for agent configuration data.
         * @param {('outreach'|'autoreply')} agentType - The type of agent to toggle.
         */
        async function toggleAgentStatus(agentType) {
            console.log("=== toggleAgentStatus CALLED ===", { agentType });

            const agent = agentStatus[agentType];
            console.log("Current agent state:", agent);

            const button = agentType === 'outreach' ? outreachToggleBtn : autoreplyToggleBtn;
            const icon = button.querySelector('i');

            let bodyData = {};

            // =====================================================================
            // STARTING AGENT
            // =====================================================================
            if (!agent.isRunning) {
                console.log("[START] Agent is currently NOT running ‚Üí Attempting to START");

                if (agentType === "autoreply") {
                    const airesponse = localStorage.getItem("airesponse");
                    console.log("Retrieved airesponse from localStorage:", airesponse);

                    if (!airesponse) {
                        alert("Required settings are missing. Please check your configuration.");
                        addLiveStatus(currentSession.id, `<span class="text-red-400">ERROR: Autoreply instructions not found.</span>`);
                        return;
                    }

                    bodyData.ai_instruction = airesponse;

                } else if (agentType === "outreach") {
                    agentType = "auto_outreach"
                    const list_of_contact = JSON.parse(localStorage.getItem("list_of_contact") || "[]");
                    const messageTemplate = localStorage.getItem("messageTemplate");

                    console.log("Retrieved outreach contact list:", list_of_contact);
                    console.log("Retrieved message template:", messageTemplate);

                    if (!list_of_contact.length || !messageTemplate) {
                        alert("Required settings are missing. Please check your configuration.");
                        addLiveStatus(currentSession.id, `<span class="text-red-400">ERROR: Contact list or message template missing.</span>`);
                        return;
                    }

                    bodyData.list_of_contact = list_of_contact;
                    bodyData.messageTemplate = messageTemplate;
                }

                // -----------------------------
                // REAL API CALL - ENABLE AGENT
                // -----------------------------
                try {
                    const apiUrl = `/api/sessions/${encodeURIComponent(currentSession.id)}/agents/${agentType}/enable`;
                    console.log("[ENABLE] API URL:", apiUrl);
                    console.log("[ENABLE] Sending body:", bodyData);

                    addLiveStatus(currentSession.id, `<span class="text-gray-400">POST ${apiUrl} ‚Äî enabling...</span>`);

                    const res = await fetch(apiUrl, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(bodyData)
                    });

                    console.log("[ENABLE] Raw Response Object:", res);

                    if (!res.ok) {
                        const text = await res.text();
                        console.error("[ENABLE] HTTP Error:", res.status, text);
                        throw new Error(`HTTP ${res.status}: ${text}`);
                    }

                    const data = await res.json();
                    console.log("[ENABLE] Parsed JSON Response:", data);

                    if (!data.success) {
                        console.error("[ENABLE] Backend responded with error:", data.message);
                        addLiveStatus(currentSession.id, `<span class="text-red-400">ERROR ENABLE: ${data.message}</span>`);
                        return;
                    }

                    console.log("[ENABLE] SUCCESS:", data.message);
                    addLiveStatus(currentSession.id, `<span class="text-green-400">${data.message}</span>`);

                } catch (err) {
                    console.error("[ENABLE] CATCH ERROR:", err);
                    addLiveStatus(currentSession.id, `<span class="text-red-400">API ERROR (enable): ${err.message}</span>`);
                    return;
                }
            }

            // =====================================================================
            // PAUSING AGENT
            // =====================================================================
            if (agent.isRunning) {
                console.log("[PAUSE] Agent IS running ‚Üí Attempting to PAUSE");

                try {
                    if (agentType === "outreach") {
                        agentType = "auto_outreach"
                        }
                    const apiUrl = `/api/sessions/${encodeURIComponent(currentSession.id)}/agents/${agentType}/pause`;
                    console.log("[PAUSE] API URL:", apiUrl);

                    addLiveStatus(currentSession.id, `<span class="text-gray-400">POST ${apiUrl} ‚Äî pausing...</span>`);

                    const res = await fetch(apiUrl, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" }
                    });

                    console.log("[PAUSE] Raw Response Object:", res);

                    if (!res.ok) {
                        const text = await res.text();
                        console.error("[PAUSE] HTTP Error:", res.status, text);
                        throw new Error(`HTTP ${res.status}: ${text}`);
                    }

                    const data = await res.json();
                    console.log("[PAUSE] Parsed JSON Response:", data);

                    if (!data.success) {
                        console.error("[PAUSE] Backend responded with error:", data.message);
                        addLiveStatus(currentSession.id, `<span class="text-red-400">ERROR PAUSE: ${data.message}</span>`);
                        return;
                    }

                    console.log("[PAUSE] SUCCESS:", data.message);
                    addLiveStatus(currentSession.id, `<span class="text-yellow-400">${data.message}</span>`);

                } catch (err) {
                    console.error("[PAUSE] CATCH ERROR:", err);
                    addLiveStatus(currentSession.id, `<span class="text-red-400">API ERROR (pause): ${err.message}</span>`);
                    return;
                }
            }

            // =====================================================================
            // UI UPDATE
            // =====================================================================
            console.log("Updating UI ‚Äî agent status flipping:", {
                oldState: agent.isRunning,
                newState: !agent.isRunning
            });

            agent.isRunning = !agent.isRunning;

            if (agent.isRunning) {
                console.log("UI: Agent is now RUNNING");
                icon.className = 'fas fa-pause text-base';
                button.title = `Pause ${agent.name}`;
                button.classList.replace('text-green-600', 'text-blue-500');
                button.classList.replace('hover:text-green-700', 'hover:text-blue-600');

                addLiveStatus(currentSession.id, `<span class="text-green-400">AGENT RUNNING: ${agent.name}</span>`);

            } else {
                console.log("UI: Agent is now PAUSED");
                icon.className = 'fas fa-play text-base';
                button.title = `Start ${agent.name}`;
                button.classList.replace('text-blue-500', 'text-green-600');
                button.classList.replace('hover:text-blue-600', 'hover:text-green-700');

                addLiveStatus(currentSession.id, `<span class="text-yellow-400">AGENT PAUSED: ${agent.name}</span>`);
            }

            console.log("=== toggleAgentStatus COMPLETED ===");
        }



        /**
         * Stops the agent completely (resets it to the initial paused state) by calling the disable endpoint.
         * @param {('outreach'|'autoreply')} agentType - The type of agent to stop.
         */
        async function stopAgent(agentType) {
            const agent = agentStatus[agentType];

            // =============
            // REAL API CALL
            // =============
            try {
                const apiUrl = `/api/sessions/${encodeURIComponent(currentSession.id)}/agents/${agentType}/disable`;

                addLiveStatus(
                    currentSession.id,
                    `<span class="text-gray-400">POST ${apiUrl} ‚Äî disabling agent...</span>`
                );

                const res = await fetch(apiUrl, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" }
                });

                if (!res.ok) {
                    const text = await res.text();
                    throw new Error(`HTTP ${res.status}: ${text}`);
                }

                const data = await res.json();

                if (!data.success) {
                    addLiveStatus(
                        currentSession.id,
                        `<span class="text-red-400">ERROR DISABLE: ${data.message}</span>`
                    );
                    return;
                }

                addLiveStatus(
                    currentSession.id,
                    `<span class="text-red-400">${data.message}</span>`
                );

            } catch (err) {
                addLiveStatus(
                    currentSession.id,
                    `<span class="text-red-400">API ERROR (disable): ${err.message}</span>`
                );
                return;
            }

            // =============
            // UPDATE UI
            // =============
            if (agent.isRunning) {
                agent.isRunning = false;

                const button = agentType === 'outreach' ? outreachToggleBtn : autoreplyToggleBtn;
                const icon = button.querySelector('i');

                // Reset to play button
                icon.className = 'fas fa-play text-base';
                button.title = `Start ${agent.name}`;

                // Colors back to idle state
                button.classList.replace('text-blue-500', 'text-green-600');
                button.classList.replace('hover:text-blue-600', 'hover:text-green-700');
            }

            console.log(`${agent.name} STOPPED and DISABLED.`);

            addLiveStatus(
                currentSession.id,
                `<span class="text-red-400">AGENT: ${agent.name} is now fully disabled.</span>`
            );
        }

/**
 * Fetches the current status of agents from the backend and updates the UI.
 */
async function loadAgentStatus() {
    if (!currentSession || !currentSession.id) return;

    try {
        const apiUrl = `/api/sessions/${encodeURIComponent(currentSession.id)}/agents/status`;
        console.log("[LOAD STATUS] Fetching agent status from:", apiUrl);

        const res = await fetch(apiUrl, {
            method: "GET",
            headers: { "Content-Type": "application/json" }
        });

        if (!res.ok) {
            const text = await res.text();
            throw new Error(`HTTP ${res.status}: ${text}`);
        }

        const data = await res.json();
        console.log("[LOAD STATUS] Response data:", data);

        if (!data.success || !data.agents) return;

        // Update each agent status based on response
        for (const [agentType, status] of Object.entries(data.agents)) {
            const agent = agentStatus[agentType === 'auto_outreach' ? 'outreach' : agentType];
            const button = agentType === 'auto_outreach' ? outreachToggleBtn : autoreplyToggleBtn;
            const icon = button.querySelector('i');

            if (status === "enabled") {
                agent.isRunning = true;
                icon.className = 'fas fa-pause text-base';
                button.title = `Pause ${agent.name}`;
                button.classList.replace('text-green-600', 'text-blue-500');
                button.classList.replace('hover:text-green-700', 'hover:text-blue-600');
            } else {
                agent.isRunning = false;
                icon.className = 'fas fa-play text-base';
                button.title = `Start ${agent.name}`;
                button.classList.replace('text-blue-500', 'text-green-600');
                button.classList.replace('hover:text-blue-600', 'hover:text-green-700');
            }

            addLiveStatus(currentSession.id, `<span class="text-gray-400">Loaded agent status: ${agent.name} ‚Üí ${status}</span>`);
        }

    } catch (err) {
        console.error("[LOAD STATUS] Error fetching agent status:", err);
        addLiveStatus(currentSession.id, `<span class="text-red-400">Error loading agent status: ${err.message}</span>`);
    }
}

        /**
         * Ensures all agent buttons are correctly set to their initial PAUSED state.
         */
        function initializeAgentButtons() {
            // Since the HTML already defaults the icons to 'fa-play' (Start),
            // we just need to confirm the state logic reflects this default.

            // Outreach
            outreachToggleBtn.querySelector('i').className = 'fas fa-play text-base';
            outreachToggleBtn.title = 'Start Outreach Agent';
            outreachToggleBtn.classList.add('text-green-600', 'hover:text-green-700');

            // Auto-Reply
            autoreplyToggleBtn.querySelector('i').className = 'fas fa-play text-base';
            autoreplyToggleBtn.title = 'Start Auto-Reply Agent';
            autoreplyToggleBtn.classList.add('text-green-600', 'hover:text-green-700');
        }


        // --- Session Management & Polling Infrastructure (Unchanged) ---

        /**
         * Function to simulate session validation.
         */
        async function getValidSessionId() {
            const urlParams = new URLSearchParams(window.location.search);
            let sessionId = urlParams.get("id");

            // If no ID ‚Üí redirect
            if (!sessionId || sessionId.trim() === "" || sessionId === "null") {
                console.warn("No session ID in URL.");
                window.location.href = "/ui/index.html";

                return null;
            }

            try {
                console.log(`Verifying session ID: ${sessionId}`);

                // Encode the session ID safely (important for characters like ||)
                const encodedId = encodeURIComponent(sessionId);

                // Correct API path
                const res = await fetch(`/api/sessions/verify/${encodedId}`, {
                    method: "GET",
                    headers: {
                        "Accept": "application/json"
                    }
                });

                if (!res.ok) {
                    console.warn(`Failed verification. Status: ${res.status}`);
                    window.location.href = "/ui/index.html";

                    return null;
                }

                const data = await res.json();
                console.log("Session verified:", data);

                // Optional: validate success flag
                if (!data.success) {
                    console.log("Invalid session ‚Üí redirect");
                                    window.location.href = "/ui/index.html";
                window.location.href = "/ui/index.html";

                    return null;
                }

                return sessionId;

            } catch (err) {
                console.error("Error verifying session:", err);
                window.location.href = "/ui/index.html";

                return null;
            }
        }

        // --- Chat History Mocking (Unchanged) ---

        async function fetchChatHistory(chatId) {
            try {
                console.log(`Fetching chat history for chat ID: ${chatId}`);

                // /sessions/{session_id}/whatsapp/chat-history
                const response = await fetch(`/api/sessions/${encodeURIComponent(sessionId)}/whatsapp/chat-history`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const backendResponse = await response.json();
                console.log("backendResponse",backendResponse)
                return backendResponse;

            } catch (error) {
                console.error('Error fetching chat history:', error);
                return {
                    success: false,
                    error: error.message,
                    chat_history: [],
                    total_groups: 0,
                    total_messages: 0
                };
            }
        }




        
        /**
         * Clears the chat interface and displays the conversation history for the selected chat.
         */
        function flattenChatHistory(backendResponse) {
            if (!backendResponse.success || !backendResponse.chat_history) {
                return [];
            }

            const flatHistory = [];

            // Iterate through each group
            backendResponse.chat_history.forEach(group => {
                // Each group is an array of messages
                group.forEach(msg => {
                    flatHistory.push({
                        sender: msg.sender === 'Me' ? 'self' : 'other',
                        text: msg.message,
                        time: msg.time,
                        originalSender: msg.sender
                    });
                });
            });

            return flatHistory;
        }
       




        
        // --- Polling Mock Utilities (Updated fetchSessionMessages) ---
        let mockMessageCounter = 0;

        function formatLogEntry(message) {
            const timestamp = new Date().toLocaleTimeString('en-US', { hour12: false });
            // Add a container div to ensure the timestamp is prepended correctly in addLiveStatus
            return `<div class="text-white"><span class="font-mono text-[10px] text-gray-400 mr-2">[${timestamp}]</span> ${message}</div>`;
        }

        function getStatusIcon(status) {
            if (status.includes("CONNECTED")) return 'fas fa-check-circle text-green-500';
            if (status.includes("IDLE") || status.includes("INITIALIZING")) return 'fas fa-sync-alt text-blue-400';
            return 'fas fa-cog text-gray-400';
        }

        function updateLiveSessionStatus(id, message, icon) {
            // Update the main header status display
            const iconClass = icon.split(' ').slice(2).join(' '); // Get color class
            statusDot.className = `status-dot mr-1 ${iconClass}`;
            statusText.textContent = currentSession.status;

            // Also push to the log
            addLiveStatus(id, `<span class="text-blue-400"><i class="${icon} mr-2"></i>STATUS: ${message}</span>`, false); // Don't format again
        }

        function addLiveStatus(id, htmlContent, shouldFormat = true) {
            const logDiv = document.createElement('div');
            logDiv.innerHTML = shouldFormat ? formatLogEntry(htmlContent) : htmlContent;

            // Log messages are prepended to appear newest at the top
            logContentContainer.prepend(logDiv.firstChild);

            // Prune old logs
            while (logContentContainer.children.length > 20) {
                logContentContainer.removeChild(logContentContainer.lastChild);
            }
        }

        function renderDashboard() {
            // This mock function updates the status text and dot based on the global session state
            const icon = currentSession.icon;
            updateLiveSessionStatus(currentSession.id, currentSession.status, icon);
        }

        async function fetchSessionMessages(sessionId, since = null) {
            const url = since
                ? `/api/sessions/${encodeURIComponent(sessionId)}/messages?since=${encodeURIComponent(since)}`
                : `/api/sessions/${encodeURIComponent(sessionId)}/messages`;

            const response = await fetch(url, {
                method: "GET",
                headers: { "Accept": "application/json" }
            });

            if (!response.ok) {
                throw new Error(`Failed to fetch messages: ${response.status}`);

            }

            const data = await response.json();
            return data.messages || [];
        }



        async function sessionPolling(session) {

            if (!session.running || session.isPaused) {
                return;
            }

            addLiveStatus(session.id, `<span class="text-gray-500">POLL: Starting API check for updates...</span>`);

            try {

                // REAL API returns only an array of messages
                const messages = await fetchSessionMessages(session.id);


                if (!Array.isArray(messages) || messages.length === 0) {
                    console.warn(`[sessionPolling] ‚ö†Ô∏è No messages found for session ${session.id}`);
                    addLiveStatus(session.id, `<span class="text-gray-500">POLL: No new messages.</span>`);
                    return;
                }

                // Take last 3 messages
                const latestMessages = messages.slice(-3).reverse();


                for (const msg of latestMessages) {

                    switch (msg.type) {
                        case "status":
                            handleStatusMessage(session, msg);
                            break;
                        case "log":
                            handleLogMessage(session, msg);
                            break;
                        case "action":
                            await handleActionMessage(session, msg);
                            break;
                        default:
                            console.warn(`[sessionPolling] Unknown message type`, msg);
                    }
                }

                // Limit logs
                if (session.statusLog.length > MAX_STATUS_LOG) {
                    session.statusLog = session.statusLog.slice(0, MAX_STATUS_LOG);
                }

                renderDashboard();

                addLiveStatus(session.id, `<span class="text-green-500">POLL: Completed successfully.</span>`);

            } catch (error) {
                console.error(`[sessionPolling] üö® NETWORK ERROR during poll for ${session.id}`, error);
                addLiveStatus(session.id, `<span class="text-red-500">NETWORK FAILED</span>`);
            }
        }


        // üü¢ HANDLERS (Unchanged)
        function handleStatusMessage(session, msg) {
            // console.log(`[handleStatusMessage] Handling STATUS message for ${session.id}`, msg);
            const { state, message, progress } = msg.content;

            session.status = state?.toUpperCase() || "UNKNOWN";
            session.icon = getStatusIcon(session.status);
            updateLiveSessionStatus(session.id, message, session.icon);
        }
        function showChat(conversationHistory) {
            chatHistoryContainer.innerHTML = '';
            
            // Store history globally for the sender to update
            currentChatHistory = conversationHistory || [];
            
            if (!conversationHistory || conversationHistory.length === 0) {
                showEmptyChatState();
                return;
            }
            
            // Reset classes for chat display mode
            chatHistoryContainer.className = 'flex-1 overflow-y-auto p-4 space-y-4 flex flex-col';

            // Loop through stored history and render using the new helper
            currentChatHistory.forEach(msg => { 
                displayNewMessage(msg.text, msg.sender, false); // Don't scroll until the end
            });
            
            setTimeout(() => {
                chatHistoryContainer.scrollTop = chatHistoryContainer.scrollHeight;
            }, 0);
        }
        function handleLogMessage(session, msg) {
            // console.log(`[handleLogMessage] Handling LOG message for ${session.id}`, msg);
            const { message, level } = msg.content;
            const levelClass = level === 'WARN' ? 'text-yellow-400' : level === 'ERROR' ? 'text-red-400' : 'text-gray-300';
            const formatted = `<span class="${levelClass}">[${level?.toUpperCase() || "INFO"}] ${message}</span>`;

            // Update session log array (used for history)
            session.statusLog.unshift(formatted);

            // Update the visible log console
            addLiveStatus(session.id, formatted);
        }

      async function handleActionMessage(session, xavir) {
        xavir=xavir.content;
    console.log(
        `[handleActionMessage] ‚ÑπÔ∏è Action detected: ${xavir.action_type} - ${xavir.chat_id}`
    );

    if (xavir.action_type === "CHAT_OPENED") {

        const chatIdToHighlight = xavir.chat_id;

        highlightedChatId = chatIdToHighlight;

        await fetchChats(window.sessionId);

        console.log("chatIdToHighlight", chatIdToHighlight);

        const chatHistory = await fetchChatHistory(chatIdToHighlight);

        showChat(flattenChatHistory(chatHistory));
        updateChatList();

        addLiveStatus(
            session.id,
            `<span class="text-yellow-300">ACTION: Chat ${chatIdToHighlight} highlighted and displayed.</span>`
        );

    } else if (xavir.action_type === "NEW_CHAT") {
        displayNewMessage(xavir.text, "other", true);
    }
}



        // --- Message Display and Sending Functions ---

        /**
         * Creates and appends a message bubble to the chat history container.
         * @param {string} text - The message content.
         * @param {('self'|'other')} sender - Who sent the message.
         * @param {boolean} shouldScroll - Whether to scroll to the bottom.
         */
        function displayNewMessage(text, sender, shouldScroll = true) {
            const isSelf = sender === 'self';

            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${isSelf ? 'justify-end' : 'justify-start'}`;

            const bubble = document.createElement('div');
            bubble.className = `chat-bubble text-sm ${isSelf ? 'chat-bubble-self' : 'chat-bubble-other'}`;
            bubble.textContent = text;

            messageDiv.appendChild(bubble);
            chatHistoryContainer.appendChild(messageDiv);

            if (shouldScroll) {
                // Ensure scroll behavior is smooth and immediate
                chatHistoryContainer.scrollTop = chatHistoryContainer.scrollHeight;
            }
        }

        /**
         * Simulates sending a message from the panel user to the currently highlighted chat.
         */
        function handleChatSend() {
            const messageText = chatInput.value.trim();
            if (messageText === "") return;

            if (!highlightedChatId) {
                console.warn(`Cannot send message: "${messageText}". No chat is currently selected.`);
                addLiveStatus(currentSession.id, `<span class="text-yellow-400">WARNING: Select a chat (e.g., chat_0) before attempting to send a message.</span>`);
                return;
            }

            // 1. Simulate API call / local processing (MOCK)
            console.log(`MOCK SEND: Sending message to chat ${highlightedChatId} from self: "${messageText}"`);

            // 2. Add to mock history (Update the current session's history array)
            currentChatHistory.push({ sender: 'self', text: messageText });

            // 3. Display the new message immediately to the user
            displayNewMessage(messageText, 'self', true);

            // 4. Clear the input
            chatInput.value = '';

            // 5. Log the action
            addLiveStatus(currentSession.id, `<span class="text-blue-400">SENT: Message sent to ${highlightedChatId}.</span>`);
        }


        // --- Modal Control Functions (Updated to use localStorage) ---
        function openModal(agentType) {
            // Hide both content sections first
            outreachSettingsContent.classList.add('hidden');
            autoreplySettingsContent.classList.add('hidden');

            if (agentType === 'outreach') {
                modalTitle.textContent = "Outreach Agent Settings";
                outreachSettingsContent.classList.remove('hidden');
            } else if (agentType === 'auto-reply') {
                modalTitle.textContent = "Auto-Reply Agent Settings";
                autoreplySettingsContent.classList.remove('hidden');
            }

            settingsModal.classList.remove('hidden');
        }

        function closeModal() {
            settingsModal.classList.add('hidden');
            // Mock function call to simulate saving/closing action
            console.log("Settings modal closed.");
        }

        function saveOutreachSettings() {
            const numbersText = document.getElementById('outreach-numbers').value;
            const message = document.getElementById('outreach-message').value;

            // Convert comma-separated string to array for list_of_contact, filtering out empty strings
            const list_of_contact = numbersText.split(',').map(n => n.trim()).filter(n => n.length > 0);

            // Save to localStorage (required by toggleAgentStatus)
            localStorage.setItem("list_of_contact", JSON.stringify(list_of_contact));
            localStorage.setItem("messageTemplate", message);

            console.log("MOCK SAVE: Outreach Settings Saved to localStorage.");
            addLiveStatus(currentSession.id, `<span class="text-green-500">SETTINGS: Outreach configuration saved successfully.</span>`);
            closeModal();
        }

        function saveAutoreplySettings() {
            const instructions = document.getElementById('autoreply-instructions').value;

            // Save to localStorage (required by toggleAgentStatus)
            localStorage.setItem("airesponse", instructions);

            console.log("MOCK SAVE: Auto-Reply Settings Saved to localStorage.");
            addLiveStatus(currentSession.id, `<span class="text-green-500">SETTINGS: Auto-Reply configuration saved successfully.</span>`);
            closeModal();
        }

        /**
         * Loads settings from localStorage into the modal inputs on initialization.
         */
        function loadAgentSettingsFromLocalStorage() {
            // Load Outreach Settings
            const list_of_contact_str = localStorage.getItem("list_of_contact");
            const messageTemplate = localStorage.getItem("messageTemplate");
            if (list_of_contact_str) {
                // Convert stored JSON array back to comma-separated string for the textarea
                const numbersText = JSON.parse(list_of_contact_str).join(', ');
                document.getElementById('outreach-numbers').value = numbersText;
            }
            if (messageTemplate) {
                document.getElementById('outreach-message').value = messageTemplate;
            }

            // Load Auto-Reply Settings
            const airesponse = localStorage.getItem("airesponse");
            if (airesponse) {
                document.getElementById('autoreply-instructions').value = airesponse;
            }
        }

        // --- Core Chat Rendering and Initialization Functions (Mostly Unchanged) ---

        /**
         * Displays the empty state when no chat is selected.
         */
        function showEmptyChatState() {
            // Store empty history
            currentChatHistory = [];

            // Ensure classes are set for proper centering
            chatHistoryContainer.className = 'flex-1 flex flex-col items-center justify-center p-8 text-center overflow-hidden';
            chatHistoryContainer.innerHTML = `
                <div class="text-gray-500 space-y-3">
                    <i class="fas fa-comments text-4xl text-gray-300"></i>
                    <p class="text-lg font-semibold">No Chat Selected</p>
                    <p class="text-sm">Awaiting agent action or manual selection. Active chat will appear here.</p>
                </div>
            `;
        }


        async function fetchChats(sessionId) {
            try {
                const url = `/api/sessions/${encodeURIComponent(sessionId)}/whatsapp/chats`;

                console.log("Calling real API:", url);

                const response = await fetch(url, {
                    method: "GET",
                    headers: {
                        "accept": "application/json"
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                // Update your global state variables
                mockChats = data.chats;
                totalChatCount = data.total_count;

                return data;

            } catch (error) {
                console.error("Error fetching chats:", error);
                return { success: false, error: error.message };
            }
        }




        async function mockFetchChats() {
            console.log("Mock API call: Fetching /whatsapp/chats...");
            await new Promise(resolve => setTimeout(resolve, 500));

            const initialMockData = {
                "success": true,
                "chats": [
                    { "id": "chat_0", "ranking": 1, "isPinned": true, "title": "+91 96538 10273", "recentMessage": "Hello, how can I help you today?" },
                    { "id": "chat_1", "ranking": 2, "isPinned": false, "title": "Suraj Raika", "recentMessage": "Thanks for your message! I'll get back to you soon." },
                    { "id": "chat_2", "ranking": 3, "isPinned": false, "title": "Papa Ji", "recentMessage": "d & f block elements -Reasoning Questions.pdf ‚Ä¢ 20 pages" },
                    { "id": "chat_4", "ranking": 5, "isPinned": true, "title": "Team Alpha Support", "recentMessage": "Ticket #500 resolved: New feature deployed successfully." }
                ],
                "total_count": 4
            };

            mockChats = initialMockData.chats;
            totalChatCount = initialMockData.total_count;

            return initialMockData;
        }

        function updateChatList() {
            if (mockChats.length === 0) {
                chatListContainer.innerHTML = `<div class="p-3 text-red-500 text-center font-medium">No active chats found.</div>`;
                countElement.textContent = "(0)";
                return;
            }

            countElement.textContent = `(${totalChatCount})`;
            chatListContainer.innerHTML = '';

            mockChats.forEach((chat) => {
                const item = createChatItem(chat);
                chatListContainer.appendChild(item);
            });
        }

        function createChatItem(chat) {

            const isHighlighted = chat.id === highlightedChatId; // Check if it's the highlighted chat

            // Base classes for the chat item
            const baseClasses = "numbers_item flex-shrink-0 py-2 px-3 transition duration-150 text-sm";

            // Default styling for non-highlighted items
            let currentClasses = "font-medium text-gray-700 bg-white";

            // Highlighting style for the selected item
            if (isHighlighted) {
                currentClasses = "bg-gray-200 font-bold text-gray-900 border-l-4 border-gray-900 shadow-inner";
            }


            const item = document.createElement('div');
            item.className = `${baseClasses} ${currentClasses}`;
            item.setAttribute('data-chat-id', chat.id);

            const iconColor = 'text-gray-400';

            const icon = `<i class="fas fa-mobile-alt mr-2 ${iconColor}"></i>`;

            const truncatedMessage = chat.recentMessage.length > 30
                ? chat.recentMessage.substring(0, 30) + '...'
                : chat.recentMessage;

            const messagePreview = `<span class="block text-[10px] text-gray-500 truncate mt-0.5 ml-5">${truncatedMessage}</span>`;

            item.innerHTML = `
                <div class="flex items-center">
                    ${icon}
                    ${chat.title} 
                    ${chat.isPinned ? '<i class="fas fa-thumbtack text-gray-500 text-[8px] ml-auto" title="Pinned Chat"></i>' : ''}
                </div>
                ${messagePreview}
            `;
            return item;
        }

        function handleAddNumber() {
            const messageContent = "New chat initialized.";
            const recipientNumber = document.getElementById('recipient-number').value.trim();

            if (!recipientNumber) {
                console.error('Validation Error: Please enter a recipient number to add.');
                return;
            }

            console.log(`Adding new number to list: ${recipientNumber}`);

            const existingChatIndex = mockChats.findIndex(chat => chat.title === recipientNumber);

            if (existingChatIndex !== -1) {
                const existingChat = mockChats[existingChatIndex];
                existingChat.recentMessage = "Chat re-initialized.";
                mockChats.splice(existingChatIndex, 1);
                mockChats.unshift(existingChat);
            } else {
                const newChat = {
                    id: `chat_${Date.now()}`,
                    ranking: 0,
                    isPinned: false,
                    title: recipientNumber,
                    recentMessage: messageContent
                };

                mockChats.unshift(newChat);
                totalChatCount++;
            }

            updateChatList();
            showEmptyChatState();
            document.getElementById('recipient-number').value = '';
        }

        // Initial setup and event listeners on window load
        window.onload = async function () {
            // 1. Validate Session ID first
            const sessionId = await getValidSessionId();
            if (!sessionId) {
                console.error("Application initialization halted due to invalid session ID.");
                chatHistoryContainer.innerHTML = '<div class="text-center p-10 text-red-500">SESSION ERROR: Please check console for details.</div>';
                return;
            }
            window.sessionId = sessionId;

            console.log(`Session ID ${sessionId} confirmed. Initializing application.`);

            // 2. Initialize the global session object
            currentSession = {
                id: sessionId,
                running: true, // Start running
                isPaused: false,
                status: "IDLE",
                icon: getStatusIcon("IDLE"),
                statusLog: [],
            };
            renderDashboard(); // Initial render of status area

            // 3. Start Polling Interval (every 3 seconds)
            setInterval(() => sessionPolling(currentSession), 500);

            // 4. Fetch initial mock chat data and render the list
            await fetchChats(window.sessionId);
            updateChatList();

            // 5. Initially show the empty chat state
            showEmptyChatState();

            // 6. Attach event listeners
            addNumberBtn.addEventListener('click', handleAddNumber);
            chatSendBtn.addEventListener('click', handleChatSend); // UPDATED
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleChatSend();
                }
            });

            // 7. Initialize agent buttons to their default (Paused/Play icon) state
            initializeAgentButtons();
loadAgentStatus(); // <-- load the backend agent status on page load

            // 8. Load persistent settings from localStorage
            loadAgentSettingsFromLocalStorage();

            // 9. Attach Modal Listeners
            document.getElementById('outreach-settings-btn').addEventListener('click', () => openModal('outreach'));
            document.getElementById('autoreply-settings-btn').addEventListener('click', () => openModal('auto-reply'));

            // Make functions globally accessible for inline onclick attributes
            window.closeModal = closeModal;
            window.saveOutreachSettings = saveOutreachSettings;
            window.saveAutoreplySettings = saveAutoreplySettings;
            window.toggleAgentStatus = toggleAgentStatus;
            window.stopAgent = stopAgent;
        };
    </script>

</body>

</html>